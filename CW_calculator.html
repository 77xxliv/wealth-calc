<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>é€€ä¼‘æ¨¡æ‹Ÿå™¨</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body { font-family: "å¾®è½¯é›…é»‘",Arial,sans-serif; background:#faf7fa; margin:0; }
.container{max-width:540px;margin:34px auto;background:#fff;padding:28px 14px 17px;border-radius:12px; box-shadow:0 0 12px #eee;}
h2{color:#154;}
label{font-weight:700;display:block; margin:15px 0 4px 0;}
input{width:120px;padding:5px;}
.tip {color:#888;font-size:12px;}
.result{margin-top:26px;padding:16px 0 0 0; border-top:1px solid #dfd;}
.small{font-size:12.5px;color:#888;}
table{margin-top:13px;width:100%;border-collapse:collapse;}
th,td{border:1px solid #ddd;padding:3px 4px;}
th{background:#eee;}
.success{color:#4c8a03;}
.warn{color:#c55;}
button{font-size:15px;background:#3680d2; border:none;padding:7px 33px;color:#fff;border-radius:5px;margin-top:17px;}
/* é­”æ³•æŒ‰é’®æ ·å¼ */
#magic-btns {margin:14px 0 0 0;display:flex;flex-wrap:wrap;gap:8px;}
.magic-btn {
  background:#eaf7ff;
  border:1px solid #aad;
  color:#2850af;
  font-size:13px;
  border-radius:4px;
  padding:4px 12px;
  cursor:pointer;
  transition:background 0.15s;
}
.magic-btn:hover { background:#d8f0ff; }
.magic-tip { font-size:13px; color:#777; margin-bottom:5px; margin-top:10px; line-height:1.5; }
#magic-tip-msg {
  color:#1976d2;
  font-size:13.5px;
  line-height:1.5;
  height: 24px;
  min-height: 24px;
  margin-top: 5px;
  margin-bottom: 7px;
  display: flex;
  align-items: center;
  transition:all .2s;
}
#magic-tip-msg:empty::after {
  content: ' ';
  visibility: hidden;
  display: inline-block;
  width:100%;
  height: 18px;
}
</style>
</head>
<body>
<div class="container">
  <h2>é€€ä¼‘æµ‹ç®—å™¨</h2>
  <form id="ff">
    <label>å½“å‰å¹´é¾„ï¼ˆå²ï¼‰</label>
    <input id="age_now" type="number" value="30" min="18" max="80">

    <label>é¢„è®¡é€€ä¼‘å¹´é¾„ï¼ˆå²ï¼‰</label>
    <input id="age_retire" type="number" value="40" min="18" max="100">

    <label>å¯é¢†å–å…»è€é‡‘å¹´é¾„ï¼ˆå²ï¼‰</label>
    <input id="age_pension" type="number" value="55" min="18" max="100">

    <label>å½“å‰å­˜æ¬¾ï¼ˆä¸‡å…ƒï¼‰</label>
    <input id="current" type="number" value="50" min="0" step="0.1">

    <label>å·¥ä½œæœŸé—´å¹´å‡å‚¨è“„ï¼ˆä¸‡å…ƒ/å¹´ï¼‰</label>
    <input id="annualsave" type="number" value="10" min="0" step="0.1">

    <label>ç†è´¢å¹´åŒ–æ”¶ç›Šç‡ï¼ˆ%ï¼‰</label>
    <input id="rate" type="number" value="5" min="0" max="15" step="0.01">

    <label>é•¿æœŸå¹³å‡é€šèƒ€ç‡ï¼ˆ%ï¼‰</label>
    <input id="inflation" type="number" value="3" min="0" max="10" step="0.01">

    <label>é€€ä¼‘åå¹´æ”¯å‡ºï¼ˆä¸‡å…ƒ/å¹´ï¼‰</label>
    <input id="spend" type="number" value="10" min="0" step="0.1">

    <label>å…»è€é‡‘é‡‘é¢ï¼ˆä¸‡å…ƒ/æœˆï¼‰</label>
    <input id="pension" type="number" value="1" min="0" step="0.01">

    <label>å…»è€é‡‘å¢é•¿ç‡ï¼ˆ%ï¼‰</label>
    <input id="pension_growth" type="number" value="2" min="0" max="10" step="0.01">

    <label>æ¨¡æ‹Ÿè‡³ä½•å¹´é¾„ï¼ˆå²ï¼‰</label>
    <input id="age_life" type="number" value="100" min="20" max="120">

    <label>æ”¶ç›Šæ³¢åŠ¨å¹…åº¦ï¼ˆ%ï¼‰</label>
    <input id="volatility" type="number" value="2" min="0" max="30" step="0.1">
    <span class="tip">æ¯å¹´æ”¶ç›Šç‡éšæœºåœ¨ Â±æ³¢åŠ¨èŒƒå›´å†…å˜åŒ–</span>

    <button type="submit">æµ‹ç®—</button>
  </form>

  <div class="magic-tip">âœ¨ ç‚¹ä¸€ç‚¹å°é­”æ³•ï¼Œçœ‹çœ‹äººç”Ÿè½¨è¿¹å¦‚ä½•å˜åŒ–ï¼</div>
  <div id="magic-tip-msg"></div>
  <div id="magic-btns"></div>
  <div class="result" id="result"></div>
</div>

<script>
function simulateRetire({
  age_now, age_retire, age_pension, age_life, current, annualsave, rate, inflation,
  spend, pension, pension_growth, volatility
}) {
  age_now = Number(age_now);
  age_retire = Number(age_retire);
  age_pension = Number(age_pension);
  age_life = Number(age_life);

  let workyears = Math.max(0, age_retire - age_now);
  let retireyears = Math.max(0, age_life - age_retire);
  let pension_gap = Math.max(0, age_pension - age_retire);
  if (age_pension <= age_retire) pension_gap = 0;

  let assets = Number(current)*10000;
  let annualsaveW = Number(annualsave)*10000;
  let baseRate = Number(rate)/100 - 0.01; // ä¿å®ˆç¼“å†²
  let vol = Number(volatility)/100;
  let i = Number(inflation)/100;
  let pg = Number(pension_growth)/100;
  let spendW = Number(spend)*10000;
  let pension_year = Number(pension)*10000*12;

  let assets_peak = 0;
  let history = [];
  let totalSpend = 0, totalPension = 0, shortfall = 0;

  // å·¥ä½œé˜¶æ®µï¼ˆå‚¨è“„åˆ†æ‘Šåˆ°å…¨å¹´ï¼‰
  for (let y=0; y<workyears; y++) {
    assets += annualsaveW / 2;
    let randRate = baseRate + (Math.random()*2 - 1) * vol;
    assets *= (1 + randRate);
    assets += annualsaveW / 2;
    history.push({year: age_now + y + 1, phase: 'å·¥ä½œ', income: annualsaveW, spend: 0, balance: assets, rate: randRate});
    assets_peak = Math.max(assets_peak, assets);
  }

  let retireStartAssets = assets;

  // é€€ä¼‘é˜¶æ®µ
  for (let j = 0; j < retireyears; j++) {
    let outflow = spendW * Math.pow(1 + i, j);
    let inflow = j >= pension_gap ? pension_year * Math.pow(1 + pg, j - pension_gap) : 0;
    assets += inflow - outflow;
    let randRate = baseRate + (Math.random()*2 - 1) * vol;
    assets *= (1 + randRate);

    totalSpend += outflow;
    totalPension += inflow;
    assets_peak = Math.max(assets_peak, assets);

    history.push({year: age_retire + j + 1, phase: 'é€€ä¼‘', income: inflow, spend: outflow, balance: assets, rate: randRate});
    if (assets <= 0 && shortfall == 0) shortfall = j + 1;
    if (assets < 0) assets = 0;
  }

  let realEndAssets = assets / Math.pow(1 + i, retireyears);

  return {retireAge: age_retire, retireStartAssets, endAssets: assets, realEndAssets,
          assets_peak, totalSpend, totalPension, shortfall, history, age_now, age_life};
}

function showResult(r){
  document.getElementById('magic-tip-msg').innerHTML = '';
  let html = `<div>ä½ è®¡åˆ’åœ¨ <b>${r.retireAge}</b> å²é€€ä¼‘ï¼Œç´¯è®¡å­˜ä¸‹ <b>${(r.retireStartAssets/10000).toFixed(1)}</b> ä¸‡å…ƒã€‚</div>`;
  if(r.shortfall==0){
    html += `<div class="success"><b>âœ“ å¯æ”¯æ’‘åˆ° ${r.age_life} å²</b>ï¼Œæœ€ç»ˆå‰©ä½™ <b>${(r.endAssets/10000).toFixed(1)}</b> ä¸‡ï¼ˆåä¹‰ï¼‰ï¼Œè´­ä¹°åŠ›æŠ˜ç®—çº¦ <b>${(r.realEndAssets/10000).toFixed(1)}</b> ä¸‡ã€‚</div>`;
  }else{
    html += `<div class="warn">âœ— èµ„é‡‘å°†åœ¨ ${r.retireAge + r.shortfall} å²è€—å°½ï¼</div>`;
  }
  html += `<div class="small">å³°å€¼ ${ (r.assets_peak/10000).toFixed(1)} ä¸‡ï½œç´¯è®¡æ”¯å‡º ${ (r.totalSpend/10000).toFixed(1)} ä¸‡ï½œç´¯è®¡å…»è€é‡‘ ${ (r.totalPension/10000).toFixed(1)} ä¸‡</div>`;
  html += `<details><summary>é€å¹´æ˜ç»†ï¼ˆå«éšæœºæ”¶ç›Šç‡ï¼‰</summary><table><tr><th>å¹´é¾„</th><th>é˜¶æ®µ</th><th>æ”¶å…¥</th><th>æ”¯å‡º</th><th>èµ„äº§</th><th>å½“å¹´æ”¶ç›Šç‡</th></tr>`;
  for(const item of r.history){
    html += `<tr><td>${item.year}</td><td>${item.phase}</td><td>${(item.income/10000).toFixed(1)}</td><td>${(item.spend/10000).toFixed(1)}</td><td>${(item.balance/10000).toFixed(2)}</td><td>${(item.rate*100).toFixed(2)}%</td></tr>`;
  }
  html += `</table></details>`;
  document.getElementById('result').innerHTML = html;
}

document.getElementById('ff').onsubmit = function(e){
  e.preventDefault();
  let vals = {
    age_now: age_now.value, age_retire: age_retire.value, age_pension: age_pension.value,
    age_life: age_life.value, current: current.value, annualsave: annualsave.value,
    rate: rate.value, inflation: inflation.value, spend: spend.value,
    pension: pension.value, pension_growth: pension_growth.value,
    volatility: volatility.value
  };
  showResult(simulateRetire(vals));
};

// é­”æ³•æŒ‰é’®
const magicList = [
  {text:"é™é€šèƒ€", op:()=>inflation.value=Math.max(0, inflation.value-1), msg:"ğŸŒ¾ é€šèƒ€ç‡-1%ï¼Œé’±æ›´å€¼é’±ï¼"},
  {text:"æ¶¨æˆ¿ä»·", op:()=>current.value=(+current.value+20).toFixed(1), msg:"ğŸ  èµ„äº§+20ä¸‡ï¼"},
  {text:"åŠ å…»è€é‡‘", op:()=>pension.value=(+pension.value+0.2).toFixed(2), msg:"ğŸ§“ å…»è€é‡‘+2000å…ƒ/æœˆï¼"},
  {text:"æå‰é€€ä¼‘", op:()=>age_retire.value=Math.max(+age_now.value+1, +age_retire.value-2), msg:"ğŸŒ´ æå‰é€€ä¼‘2å¹´ï¼"},
  {text:"å»¶åé€€ä¼‘", op:()=>age_retire.value=Math.min(+age_life.value-1, +age_retire.value+2), msg:"ğŸ’¼ å»¶åé€€ä¼‘2å¹´ï¼"},
  {text:"å‡å°‘æ”¯å‡º", op:()=>spend.value=Math.max(0, spend.value-1).toFixed(1), msg:"ğŸ‹ æ¯å¹´çœ1ä¸‡ï¼"},
  {text:"åŠ æ”¶ç›Šç‡", op:()=>rate.value=Math.min(15, +rate.value+1), msg:"ğŸš€ æ”¶ç›Šç‡+1%ï¼"}
];

function renderMagicBtns(){
  let area = document.getElementById('magic-btns');
  magicList.forEach(item=>{
    let btn=document.createElement('button');
    btn.type="button"; btn.className="magic-btn"; btn.innerText=item.text;
    btn.onclick=()=>{item.op(); ff.dispatchEvent(new Event('submit')); setTimeout(()=>magicTip(item.msg),60)};
    area.appendChild(btn);
  });
}
function magicTip(msg){ document.getElementById('magic-tip-msg').innerHTML = msg; }

renderMagicBtns();
setTimeout(()=>ff.dispatchEvent(new Event('submit')),250);
</script>
</body>
</html>
