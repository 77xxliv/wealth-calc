<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>退休模拟器</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: "微软雅黑",Arial,sans-serif; background:#faf7fa; margin:0; }
    .container{max-width:540px;margin:34px auto;background:#fff;padding:28px 14px 17px;border-radius:12px; box-shadow:0 0 12px #eee;}
    h2{color:#154;}
    label{font-weight:700;display:block; margin:15px 0 4px 0;}
    input{width:120px;padding:5px;}
    .tip {color:#888;font-size:12px;}
    .result{margin-top:26px;padding:16px 0 0 0; border-top:1px solid #dfd;}
    .small{font-size:12.5px;color:#888;}
    table{margin-top:13px;width:100%;border-collapse:collapse;}
    th,td{border:1px solid #ddd;padding:3px 4px;}
    th{background:#eee;}
    .success{color:#4c8a03;}
    .warn{color:#c55;}
    button{font-size:15px;background:#3680d2; border:none;padding:7px 33px;color:#fff;border-radius:5px;margin-top:17px;}
  </style>
</head>
<body>
  <div class="container">
    <h2>退休测算器</h2>
    <form id="ff">
      <label>当前年龄（岁）</label>
      <input id="age_now" type="number" value="30" min="18" max="80">
      <span class="tip">工作起点年龄</span>

      <label>预计退休年龄（岁）</label>
      <input id="age_retire" type="number" value="40" min="18" max="100">
      <span class="tip">想多少岁不工作，或试算一个目标</span>

      <label>可领取养老金年龄（岁）</label>
      <input id="age_pension" type="number" value="55" min="18" max="100">
      <span class="tip">养老金账户可发放的年龄（含企业/社保/公积金）</span>

      <label>当前存款（万元）</label>
      <input id="current" type="number" value="50" min="0" step="0.1">
      <span class="tip">现有可投资净资产</span>

      <label>工作期间年均储蓄（万元/年）</label>
      <input id="annualsave" type="number" value="10" min="0" step="0.1">
      <span class="tip">可自由调整以模拟不同储蓄计划</span>

      <label>理财年化收益率（%）</label>
      <input id="rate" type="number" value="5" min="0" max="15" step="0.01">
      <span class="tip">退休和工作期间均按此收益率计复利</span>

      <label>长期平均通胀率（%）</label>
      <input id="inflation" type="number" value="3" min="0" max="10" step="0.01">
      <span class="tip">用来测算真实购买力变化</span>

      <label>退休后年支出（万元/年）</label>
      <input id="spend" type="number" value="10" min="0" step="0.1">
      <span class="tip">包括养老保险后自己需覆盖的总生活成本</span>

      <label>养老金金额（月）</label>
      <input id="pension" type="number" value="1" min="0" step="1">
      <span class="tip">每月现值，自动按通胀调增</span>
      
      <label>模拟至何年龄（岁）</label>
      <input id="age_life" type="number" value="100" min="20" max="120">
      <span class="tip">测算到哪一年结束</span>

      <button type="submit">测算</button>
    </form>
    <div class="result" id="result"></div>
  </div>

<script>
// 主测算函数：所有年龄转换为年数
function simulateRetire({
  age_now, age_retire, age_pension, age_life, current, annualsave, rate, inflation,
  spend, pension
}) {
  age_now = Number(age_now);
  age_retire = Number(age_retire);
  age_pension = Number(age_pension);
  age_life = Number(age_life);

  let workyears = Math.max(0, age_retire - age_now);
  let retireyears = Math.max(0, age_life - age_retire);
  let pension_gap = Math.max(0, age_pension - age_retire);
  if (age_pension <= age_retire) pension_gap = 0;

  let assets = Number(current)*10000;
  let annualsaveW = Number(annualsave)*10000;
  let r = Number(rate)/100;
  let i = Number(inflation)/100;
  let spendW = Number(spend)*10000;
  let pension_year = Number(pension)*10000*12;

  let assets_peak = 0;
  let year = 0;
  let history = [];
  let totalSpend = 0, totalPension = 0, shortfall = 0;

  // 工作存钱阶段
  for (; year < workyears; year++) {
    assets *= (1 + r);
    assets += annualsaveW;
    history.push({
      year: age_now + year + 1,
      phase: '工作',
      income: annualsaveW,
      spend: 0,
      spendAdj: 0,
      pension: 0,
      balance: assets
    });
    assets_peak = Math.max(assets_peak, assets);
  }

  let retireAge = age_retire;
  let retireStartAssets = assets;

  // 退休阶段
  for (let j = 0; j < retireyears; j++) {
    assets *= (1 + r);
    let outflow = spendW * Math.pow(1 + i, j); // 通胀调整后支出
    let inflow = 0;
    if (j >= pension_gap) {
      inflow = pension_year * Math.pow(1 + i, j - pension_gap); // 养老金也考虑通胀增长
    }
    assets += inflow - outflow;
    totalSpend += outflow;
    totalPension += inflow;
    assets_peak = Math.max(assets_peak, assets);

    history.push({
      year: retireAge + j + 1,
      phase: '退休',
      income: inflow,
      spend: outflow,
      spendAdj: outflow / (Math.pow(1 + i, j)), // 真实支出
      pension: inflow,
      balance: assets
    });
    if (assets <= 0 && shortfall == 0) shortfall = j + 1;
    if (assets < 0) assets = 0;
  }

  return {
    retireAge,
    retireStartAssets,
    endAssets: assets,
    assets_peak,
    totalSpend,
    totalPension,
    shortfall,
    history,
    age_now,
    age_life
  }
}

function showResult(r){
  let html = '';
  html += `<div>你计划在 <b>${r.retireAge}</b> 岁退休，累计存下 <b>${(r.retireStartAssets/10000).toFixed(1)}</b> 万元。</div>`;
  if(r.shortfall==0){
    html += `<div class="success" style="margin:11px 0 3px 0;"><b>✓ 可从 <b>${r.retireAge}</b> 岁一直支撑到 <b>${r.age_life}</b> 岁，最终还能剩余 <b>${(r.endAssets/10000).toFixed(1)}</b> 万元！</b></div>`;
  }else{
    let failage = r.retireAge + r.shortfall;
    html += `<div class="warn" style="margin:11px 0 3px 0;">✗ 资金将在 <b>${failage}</b> 岁（退休第${r.shortfall}年）耗尽！可考虑增加本金、减少支出或延迟退休。</div>`;
  }
  html += `<div class="small">【资金峰值】${(r.assets_peak/10000).toFixed(1)} 万｜累计（名义）支出 ${(r.totalSpend/10000).toFixed(1)} 万｜累计领养老金 ${(r.totalPension/10000).toFixed(1)} 万</div>`;
  html += `<details style="margin-top:20px;"><summary style="cursor:pointer;">逐年明细</summary><table><tr><th>年龄</th><th>阶段</th><th>收入/养老金</th><th>花费</th><th>年终资产</th></tr>`;
  for(const item of r.history){
    html += `<tr><td>${item.year}</td><td>${item.phase}</td><td>${(item.income/10000).toFixed(1)}</td><td>${(item.spend/10000).toFixed(1)}</td><td>${(item.balance/10000).toFixed(2)}</td></tr>`;
  }
  html += `</table></details>`;
  html += `<div class="small" style="margin-top:10px;line-height:1.6">
  说明：只需填写年龄点，系统自动推算存钱年数与养老金断档年数。退休后每年按通胀调整支出，养老金、理财收益全部复利计入。集中压力测试影响决策。
  <br>建议：依自身风险承受力，合理设置年化收益率和通胀，并多尝试不同退休/养老金年龄。养老金可选通胀递增（输入时同步调整），长期理财组合建议重视抗通胀和稳健收益。
  </div>`;
  document.getElementById('result').innerHTML = html;
}

document.getElementById('ff').onsubmit = function(e){
  e.preventDefault();
  let vals = {
    age_now: document.getElementById('age_now').value,
    age_retire: document.getElementById('age_retire').value,
    age_pension: document.getElementById('age_pension').value,
    age_life: document.getElementById('age_life').value,
    current: document.getElementById('current').value,
    annualsave: document.getElementById('annualsave').value,
    rate: document.getElementById('rate').value,
    inflation: document.getElementById('inflation').value,
    spend: document.getElementById('spend').value,
    pension: document.getElementById('pension').value,
  };
  let ret = simulateRetire(vals);
  showResult(ret);
};
// 默认自动试算一次
setTimeout(()=>{document.getElementById('ff').dispatchEvent(new Event('submit'));},250);
</script>
</body>
</html>
